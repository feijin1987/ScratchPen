<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Scratch Pen</title>
    <script src="bower_components/blockly/blockly_compressed.js"></script>
    <script src="bower_components/blockly/blocks_compressed.js"></script>
    <script src="bower_components/blockly/msg/js/en.js"></script>
    <script src="bower_components/blockly/javascript_compressed.js"></script>
    <script src="bower_components/jquery/dist/jquery.min.js"></script>
    <script src="bower_components/firebase/firebase.js"></script>
    <script src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="bower_components/moment/moment.js"></script>
    <script src="bower_components/js-signals/dist/signals.min.js"></script>
    <script src="bower_components/crossroads/dist/crossroads.min.js"></script>
    <script src="bower_components/hasher/dist/js/hasher.min.js"></script>
    <!-- update the version number as needed -->
    <script defer src="/__/firebase/4.6.0/firebase-app.js"></script>
    <!-- include only the Firebase features as you need -->
    <script defer src="/__/firebase/4.6.0/firebase-auth.js"></script>
    <script defer src="/__/firebase/4.6.0/firebase-database.js"></script>
    <script defer src="/__/firebase/4.6.0/firebase-messaging.js"></script>
    <script defer src="/__/firebase/4.6.0/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.6.0/firebase.js"></script>

    <script src="bower_components/awesomplete/awesomplete.min.js"></script>
    <!-- initialize the SDK after all desired features are loaded -->
    <script defer src="/__/firebase/init.js"></script>
    <script src="js/customBlocks.js"></script>
    <script src="js/authentication.js"></script>
    <script src="js/save.js"></script>
    <script src="js/dashboard.js"></script>

    <link rel="stylesheet" href="css/index.css">
    <link rel="stylesheet" href="css/application.css">
    <link rel="stylesheet" href="css/toolkit.css">
    <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="bower_components/awesomplete/awesomplete.css">
</head>

<body>
    <div class="main-container">
        <!--This is the top toolbar-->
        <nav class="navbar navbar-inverse navbar-fixed-top">
            <div class="toolbar-container">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="#">ScratchPen</a>
                </div>
                <div class="navbar-collapse collapse">
                    <ul class="nav navbar-nav">
                        <li class="active"><a href="#">Home</a></li>
                        <li><a href="#about">About</a></li>
                        <li><a href="#contact">Contact</a></li>
                        <li class="dropdown"><a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">More Options <span class="caret"></span></a>
                            <ul class="dropdown-menu">
                                <li><a href="#">Action</a></li>
                                <li><a href="#">Another action</a></li>
                                <li><a href="#">Something else here</a></li>
                                <li role="separator" class="divider"></li>
                                <li class="dropdown-header">Nav header</li>
                                <li><a href="#">Separated link</a></li>
                                <li><a href="#">One more separated link</a></li>
                            </ul>
                        </li>

                    </ul>
                    <!--<form class="navbar-form navbar-right">
          <div class="form-group">
          <input type="text" placeholder="Email" class="form-control">
        </div>
        <div class="form-group">
        <input type="password" placeholder="Password" class="form-control">
      </div>
      <button type="submit" class="btn btn-primary">Sign in</button>
    </form>-->
                    <div class="navbar-right">
                        <form class="navbar-form navbar-left">
                            <input class="dropdown-input" placeholder="Search for a project.." />
                            <button class="dropdown-btn" type="button"><span class="caret"></span></button>
                        </form>
                        <label id="userLabel"> </label>
                        <button type="button" class="btn btn-link navbar-btn" id="join">Join ScratchPen</button>
                        <button type="button" class="btn btn-primary navbar-btn" id="login">Sign In</button>
                        <button type="button" class="btn btn-danger navbar-btn" id="logout">Log Out</button>
                    </div>
                </div>
            </div>
        </nav>

        <!--Below is the home page dashboard-->
        <div class="jumbotron">
            <div class="container text-center">
                <h1>ScratchPen</h1>
                <p>Mission, Vission & Values</p>
            </div>
        </div>
        <div class="container dashboard-container">

        </div>
        <br>
        <!--End of dashboard-->

        <!--Thumbnail start-->
        <div class="row project-list">
            <div class="col-sm-6 col-md-3">
                <div class="thumbnail">
                    <img id="newProject" class="newProjectThumbnail" src="images/add_circle_grey.png" alt="...">
                    <div class="caption">
                        <h3>Create A New Project</h3>
                    </div>
                </div>
            </div>
        </div>
        <!--Thumbnail End-->

        <div id="scratch">
            <div class="project-info">
                <div><h1 class="project-info-name">This is New Project</h1></div>
                <div><h4 class="project-info-user">Created By - </h4></div>
            </div>
            <div class="scratchContainer">
                <div class="alert alert-danger notification" role="alert">
                    <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                    <span class="sr-only">Error:</span>
                </div>
                <div id="blocklyDiv"></div>
                <div class="col-sm-3 col-md-2 sidebar scratch-options">
                    <ul class="nav nav-sidebar">
                        <li class="active"><a href="#">New Project <span class="sr-only">(current)</span></a></li>
                        <li><a id="save" href="#">Save Project</a></li>
                        <li><a id="saveVersion" href="#">Save Version</a></li>
                        <li><a id="uploadVersion" href="#">Upload from Version</a></li>
                        <li><a id="import" href="#">Import</a></li>
                        <li><a id="export" href="#">Export</a></li>
                    </ul>
                    <ul class="nav nav-sidebar">
                        <li><a href="">Play</a></li>
                        <li><a id="codeReuse" href="#">Code reuse</a></li>
                        <!--<li><a href="">One more nav</a></li>-->
                        <!--<li><a href="">Another nav item</a></li>-->
                        <!--<li><a href="">More navigation</a></li>-->
                    </ul>
                    <!--<ul class="nav nav-sidebar">-->
                        <!--<li><a href="">Nav item again</a></li>-->
                        <!--<li><a href="">One more nav</a></li>-->
                        <!--<li><a href="">Another nav item</a></li>-->
                    <!--</ul>-->
                </div>
                <div class="text-container">
                    <pre id="textGenerator" class="prettyprint lang-js"></pre>
                    <!--<textarea id="textGenerator"></textarea>-->
                    <!--<div class="play-code"></div>-->
                    <!--<div class="save-code"></div>-->
                    <!--<div class="load-code"></div>-->
                    <div class="playground-container">
                        <div class="playground"></div>
                    </div>
                </div>
                <!-- Modal -->
                <div class="modal fade" id="saveModal" tabindex="-1" role="dialog" aria-labelledby="modalLabel">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                <h4 class="modal-title" id="modalLabel">Enter Project Details</h4>
                            </div>
                            <div class="modal-body">
                                <div class="form-group">
                                    <input type="text" id="projectName" class="form-control" placeholder="Enter project name" aria-describedby="sizing-addon1">
                                </div>
                                <span></span>
                                <div class="form-group">
                                    <input type="text" id="projectDesc" class="form-control" placeholder="Enter project description" aria-describedby="sizing-addon1">
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                                <button type="button" id="saveProject" class="btn btn-primary">Save changes</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!----End Modal ---->
                <!-- Modal -->
                <div class="modal fade" id="openVersionModal" tabindex="-1" role="dialog" aria-labelledby="modalLabelVersion">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                <h4 class="modal-title" id="modalLabelVersion">Select version from available versions</h4>
                            </div>
                            <div class="modal-body">
                                <div class="dropdown">
                                    <button class="btn btn-primary dropdown-toggle" id="menu2" type="button" data-toggle="dropdown">
                                        <span id="versionSelected">Select version</span><span class="caret"></span></button>
                                    <ul class="dropdown-menu version-list" role="menu" aria-labelledby="menu2">
                                    </ul>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                                <button type="button" id="openVersion" class="btn btn-primary">Load version</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!----End Modal ---->
                <!-- Modal -->
                <div class="modal fade" id="exportModal" tabindex="-1" role="dialog" aria-labelledby="modalLabelExport">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                <h4 class="modal-title" id="modalLabel">Exporting project</h4>
                            </div>
                            <div class="modal-body">
                                <div class="form-group">
                                    <p>Copy the xml code below and share it with your friends!</p>
                                    <input type="text" id="exportName" class="form-control" aria-describedby="sizing-addon1">
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!----End Modal ---->
                <!-- Modal -->
                <div class="modal fade" id="importModal" tabindex="-1" role="dialog" aria-labelledby="modalLabelExport">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                <h4 class="modal-title" id="modalLabel">Import project</h4>
                            </div>
                            <div class="modal-body">
                                <div class="form-group">
                                    <p>Paste the blockly xml code</p>
                                    <input type="text" id="importData" class="form-control" aria-describedby="sizing-addon1">
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                                <button type="button" id="importProject" class="btn btn-primary">Save changes</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!----End Modal ---->
                <!-- Modal -->
                <div class="modal fade" id="reuseModal" tabindex="-1" role="dialog" aria-labelledby="modalLabelVersion">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                <h4 class="modal-title" id="modalLabelVersion">Reuse Projects</h4>
                            </div>
                            <div class="modal-body">
                                <!-- Large button group -->
                                <div class="dropdown">
                                    <button class="btn btn-primary dropdown-toggle" id="menu1" type="button" data-toggle="dropdown">
                                        <span id="reuseSelected">Select project for reuse</span><span class="caret"></span></button>
                                    <ul class="dropdown-menu blockList" role="menu" aria-labelledby="menu1">
                                    </ul>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                                <button type="button" id="reuseBlocks" class="btn btn-primary">Reuse Blocks</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!----End Modal ---->

            </div>
        </div>

        <div class="container-fluid container-fill-height create-container" id="create">
            <div class="container-content-middle">
                <form role="form" class="m-x-auto text-center app-login-form create-login-form">
                    <a href="../index.html" class="app-brand m-b-lg">
                        <img src="/images/lock.svg" alt="lock">
                    </a>
                    <div class="form-group">
                        <input class="form-control" id="email" placeholder="email">
                    </div>
                    <div class="form-group m-b-md">
                        <input class="form-control" type="password" id="password" placeholder="Password">
                    </div>
                    <div class="m-b-lg">
                        <button type="button" class="btn btn-primary" id="sign-up">Create</button>
                        <button type="button" class="btn btn-danger" id="cancel1">Cancel</button>
                    </div>
                </form>

            </div>
        </div>
        <div class="container-fluid container-fill-height signin-contatiner" id="signin">
            <div class="container-content-middle">
                <form role="form" class="m-x-auto text-center app-login-form signin-login-form">
                    <a href="../index.html" class="app-brand m-b-lg">
                        <img src="/images/lock.svg" alt="brand">
                    </a>
                    <div class="form-group">
                        <button type="button" class="loginBtn loginBtn--facebook" id="facebook-login">Login with Facebook</button>
                    </div>
                    <div class="form-group m-b-md">
                        <button type="button" class="loginBtn loginBtn--google" id="google-login">Login with Google</button>
                    </div>
                    <div class="form-group">
                        <input class="form-control" id="email_signin" placeholder="Email">
                    </div>
                    <div class="form-group m-b-md">
                        <input type="password" class="form-control" id="password_signin" placeholder="Password">
                    </div>
                    <div class="m-b-lg">
                        <button type="button" class="btn btn-primary" id="sign-in">Log In</button>
                        <button type="button" class="btn btn-default" id="signupButton">Sign up</button>
                        <button type="button" class="btn btn-danger" id="cancel2">Cancel</button>
                    </div>

                    <!-- <footer class="screen-login">
      <a href="#" class="text-muted">Forgot password</a>
    </footer> -->
                </form>
            </div>
        </div>
        <div class="comments">
        <div class="container">
            <div class="comment-box">
                <div class="comment-form">
                    <div class="header">Add Your Comment</div>
                    <form>
                        <div>
                            <input type="text" id="yourName" placeholder="Name" />
                        </div>
                        <div>
                            <textarea id="comment" rows="3" cols="30" placeholder="Comment"></textarea>
                        </div>
                        <div class="alert alert-danger notification" role="alert">
                            <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                            <span class="sr-only">Error:</span>
                        </div>
                        <button type="button" class="scratch-options" id="commentButton">COMMENT</button>
                    </form>
                </div>
                <div>
                    <h4 class="header">Comments</h4>
                    <div id="commentsList"></div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!--<div class="comments">-->
        <!--<div class="container">-->
            <!--<div class="comment-box">-->
                <!--<div class="comment-form">-->
                    <!--<div class="header">Add Your Comment</div>-->
                    <!--<form>-->
                        <!--<div>-->
                            <!--<input type="text" id="yourName" placeholder="Name" />-->
                        <!--</div>-->
                        <!--<div>-->
                            <!--<textarea id="comment" rows="3" cols="30" placeholder="Comment"></textarea>-->
                        <!--</div>-->
                        <!--<div class="alert alert-danger notification" role="alert">-->
                            <!--<span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>-->
                            <!--<span class="sr-only">Error:</span>-->
                        <!--</div>-->
                        <!--<button type="button" class="scratch-options" id="commentButton">COMMENT</button>-->
                    <!--</form>-->
                <!--</div>-->
                <!--<div>-->
                    <!--<h4 class="header">Comments</h4>-->
                    <!--<div id="commentsList"></div>-->
                <!--</div>-->
            <!--</div>-->
        <!--</div>-->
    <!--</div>-->

    <!--This is the main script tap.Add to new functions at the end  in function document.addEventListner-->
    <script>
        // execute/clear BS loaders for docs
        $(function() {
            if (window.BS && window.BS.loader && window.BS.loader.length) {
                while (BS.loader.length) {
                    (BS.loader.pop())()
                }
            }
        });
        var config = {
            apiKey: "AIzaSyD-8lQUILli9sLB30y-cekNONwjIBzdiOg",
            authDomain: "scratchpen-de051.firebaseapp.com",
            databaseURL: "https://scratchpen-de051.firebaseio.com",
            projectId: "scratchpen-de051",
            strageBucket: "scratchpen-de051.appspot.com",
            messagingSenderId: "355301139728"
        };

        firebase.initializeApp(config);
        // Get a reference to the storage service, which is used to create references in your storage bucket
        var storage = firebase.storage();


        //Entry point into the application
        document.addEventListener('DOMContentLoaded', function() {
            var $ = jQuery;
            //authentication.init();
            var database = firebase.database();
            var workspace = Blockly.inject('blocklyDiv', {
                toolbox: toolbox
            });
            var globalVar = {
                setStorageValue: function(key, value) {
                    sessionStorage.setItem(key, value);
                },
                getStorageValue: function(key) {
                    return sessionStorage.getItem(key)
                },
                fbDatabase: database,
                generateUniqueID: function() {
                    return Math.random().toString(36).substr(2, 9);
                },
                currentProjectId: null,
                getCurrentProjectId: function() {
                    return this.currentProjectId
                },
                currentProjectName: null,
                getCurrentProjectName: function() {
                    return this.currentProjectName
                },
                workspace: workspace,
                getTimeStamp: function() {
                    return Date.now();
                },
                user: null, //Storing logged in user
                projectsInDOM: []
            };
            authentication.globalVar = globalVar;
            saveObj.globarVar = globalVar;
            authentication.addClickListner();
            dash.globalVar = globalVar;

            Blockly.Blocks['move'] = {
                init: function() {
                    this.appendDummyInput().appendField('Move ').appendField(new Blockly.FieldNumber('10'),
                        'FIELDNAME');
                    this.setPreviousStatement(true);
                    this.setNextStatement(true);
                    this.setColour(160);
                    this.setTooltip('Returns number of letters in the provided text.');
                    this.setHelpUrl('http://www.w3schools.com/jsref/jsref_length_string.asp');
                }
            };

            Blockly.Blocks['turn_clockwise'] = {
                init: function() {
                    this.appendDummyInput().appendField('turn clockwise ').appendField(new Blockly.FieldNumber('10'), 'FIELDNAME').appendField(' deg');
                    this.setPreviousStatement(true);
                    this.setNextStatement(true);
                    this.setColour(160);
                    this.setTooltip('Returns number of letters in the provided text.');
                    this.setHelpUrl('http://www.w3schools.com/jsref/jsref_length_string.asp');
                }
            };

            //Firebase session details
            firebase.auth().onAuthStateChanged(function(user) {
                crossroads.addRoute("main", function() {
                    //console.log("I am in the routes");
                });
                hasher.init();
                hasher.setHash("main");

                if (user) {
                    $(".project-list").show();
                    $("#login").hide();
                    $("#join").hide();
                    $("#scratch").hide();
                    $('#logout').show();
                    $("#signin").hide();
                    $("#create").hide();
                    $(".comments").hide();
                    $("#userLabel").text("Logged in as " + user.email);
                    globalVar.user = user;
                    if (!globalVar.getStorageValue("email")) {
                        globalVar.setStorageValue("email", user.email)
                    }
                    var ref = firebase.app().database().ref();
                    var usersRef = ref.child('Users/' + user.uid + '/projects');
                    usersRef.once('value', function(snap) {
                        var projects = snap.val(); // Keep the local user object synced with the Firebase userRef
                        //console.log(projects);
                        for (var p in projects) {
                            var projectListDOM = '<div class="col-sm-6 col-md-4">' +
                                '<div class="thumbnail">' +
                                //'<img src="..." alt="...">'+
                                '<div class="caption">' +
                                '<h3>' + projects[p]["name"] + '</h3>' +
                                '<p>' + projects[p]["desc"] + '</p>' +
                                '<p>' +
                                '<a href="#" id = ' + p + '_open ' + 'class="btn btn-primary" role="button">Open</a>' + '\r\r' +
                                '<a href="#" id = ' + p + '_delete ' + 'class="btn btn-default" role="button">Delete</a>' +
                                '</p>' +
                                '</div>' +
                                '</div>' +
                                '</div>';
                            $(".project-list").append(projectListDOM);
                            $("#" + p + "_open").click(openProject);
                        }
                    });
                } else {
                    authentication.init();
                    dash.init();
                    console.log("not logged in");
                }
            });

            var saveChangesModal = function() {
                var projectName = $("#projectName")[0].value;
                var projectDesc = $("#projectDesc")[0].value;
                var uid = globalVar.generateUniqueID(); //Unique Id for Project
                var versionData = {};
                var timeStamp = globalVar.getTimeStamp();
                versionData[timeStamp] = saveObj.blockToXml(true); //Timestamp is unique ID for version
                globalVar.fbDatabase.ref("/Projects/" + uid).set({
                    "name": projectName,
                    "desc": projectDesc,
                    "timeStamp": timeStamp,
                    "author": globalVar.getStorageValue("email"),
                    "versions": versionData
                }).then(function() {
                    $("#saveModal").modal('hide');
                    globalVar.currentProject = projectName;
                    globalVar.currentProjectId = uid;
                    var updates = {};
                    updates['/Users/' + globalVar.user.uid + '/projects/' + uid] = {
                        "name": projectName,
                        "desc": projectDesc,
                        "timestamp": timeStamp
                    };
                    return firebase.database().ref().update(updates);
                }).catch(function(error) {
                    //console.log("error saving project" ,error);
                });
            };

            var saveToolbar = function() {
                if ($("#login").is(":visible")) {
                    $(".notification").html("Please login to save").show();
                    setTimeout(function() {
                        $(".notification").fadeOut("slow");
                    }, 1000);
                } else {
                    $("#saveModal").modal();
                }
            };

            var blockToText = function(event) {
                var code = Blockly.JavaScript.workspaceToCode(workspace);
                document.getElementById('textGenerator').innerText = code; //puts block code into text editor
                //console.log(code);
            };

            var saveVersion = function() {
                var newVersion = Date.now();
                // Write the new post's data simultaneously in the posts list and the user's post list.
                var updates = {};
                //var ref = firebase.database().ref('/Projects/' + globalVar.currentProjectId + '/versions/');
                updates['/Projects/' + globalVar.currentProjectId + '/versions/' + newVersion] = saveObj.blockToXml(true);
                return firebase.database().ref().update(updates);
            };

            var openProject = function(event) {
                var projectID = event.currentTarget.id.split("_")[0];
                commonOpenProject(projectID);
            };

            function commonOpenProject(projectID) {
                globalVar.currentProjectId = projectID;
                var ref = firebase.app().database().ref();
                var projRef = ref.child('Projects/' + projectID + '/versions');
                projRef.once('value', function(snap) {
                    //console.log(snap);
                    //loading most recent from version//
                    var versions = Object.keys(snap.val());
                    var versionsLen = Object.keys(snap.val()).length;
                    var mostRecent = versions[versionsLen - 1];
                    $(".project-list").hide();
                    $("#scratch").show();
                    //loading blocks into DOM
                    var xml = Blockly.Xml.textToDom(snap.val()[mostRecent]);
                    Blockly.Xml.domToWorkspace(xml, workspace);

                });

                var commentRef = ref.child('Projects/' + projectID + '/comments');
                commentRef.on("child_added", function(snapshot) {
                    let comment = snapshot.val();
                    addComment(comment.name, comment.comment, comment.time);
                });
                $(".comments").show();
            }
            var openNewProject = function() {
                //Resetting blocks
                $("#scratch").show();
                $(".project-list").hide();
                Blockly.mainWorkspace.clear();
                $(".comments").show();
            };

            var openFromVersion = function() {
                var projectID = globalVar.currentProjectId;
                var ref = firebase.app().database().ref();
                var projRef = ref.child('Projects/' + projectID + '/versions');
                $(".version-list").empty();
                projRef.once('value', function(snap) {
                    //console.log(snap.val());
                    var versionObj = snap.val();
                    var list = $(".version-list");
                    for (var obj in versionObj) {
                        list.append("<li role=\"presentation\"><a role=\"menuitem\" tabindex=\"-1\" href=\"#\">" + moment(Number(obj)).format("DD/MM/YYYY h:mm:ss") + "   -   " + obj + "</a></li>");

                    }
                }).then(function() {
                    $("#openVersionModal").modal();
                    $('.dropdown-menu a').click(function() {
                        $('#versionSelected').text($(this).text());

                    })
                });
            };

            //opening the selected version
            //Reusing  int the project
            var versionOpenModal = function() {
                var version = (document.getElementById("versionSelected").innerHTML).split("   -   ")[1];
                var selectedXML;

                if (version) {
                    var projectID = globalVar.currentProjectId;
                    var ref = firebase.app().database().ref();
                    var projRef = ref.child('Projects/' + projectID + '/versions');
                    projRef.once('value', function(snap) {
                        //console.log(snap.val());
                        var versionObj = snap.val();
                        var list = $(".version-list");
                        selectedXML = versionObj[version];

                    }).then(function() {
                        //loading blocks into DOM
                        $("#openVersionModal").modal('hide');
                        $("#scratch").show();
                        Blockly.mainWorkspace.clear();
                        var xml = Blockly.Xml.textToDom(selectedXML);
                        Blockly.Xml.domToWorkspace(xml, workspace);
                        $(".version-list").empty();

                    });

                } else {
                    //console.log("Please enter correct xml format");
                }

            };

            //Exporting project
            var exportToolbar = function() {
                if ($("#login").is(":visible")) {
                    $(".notification").html("Please login to save").show();
                    setTimeout(function() {
                        $(".notification").fadeOut("slow");
                    }, 1000);
                } else {
                    $("#exportModal").modal();
                    var exportObj = saveObj.blockToXml(true);
                    $("#exportName").attr("value", exportObj);
                }
            };

            //Importing project
            var importToolbar = function() {
                if ($("#login").is(":visible")) {
                    $(".notification").html("Please login to save").show();
                    setTimeout(function() {
                        $(".notification").fadeOut("slow");
                    }, 1000);
                } else {
                    $("#importModal").modal();
                }
            };

            //Importing the project
            var importChangesModal = function() {
                var importData = $("#importData")[0].value;
                if (importData) {
                    //loading blocks into DOM
                    $("#importModal").modal('hide');
                    Blockly.mainWorkspace.clear();
                    $("#scratch").show();
                    //console.log(importData);
                    //Blockly.mainWorkspace.clear();
                    var xml = Blockly.Xml.textToDom(importData);
                    //console.log(xml);
                    Blockly.Xml.domToWorkspace(xml, workspace);
                    //console.log("hello");
                } else {
                    //console.log("Please enter correct xml format");
                }

            };

            //Autocomplete
            var searchProjects;
            var allProjects = function() {
                searchProjects = {};
                var projectNames = [];
                var projectXML = [];
                var ref = firebase.app().database().ref();
                var searchRef = ref.child('Projects');
                var i = 0;
                searchRef.once('value', function(snap) {
                    var searchObj = snap.val();
                    for (var obj in searchObj) {
                        var latestVersion;
                        for (var version in searchObj[obj].versions) {
                            latestVersion = searchObj[obj].versions[version];
                        }
                        projectNames.push(searchObj[obj].name);
                        projectXML.push(latestVersion);
                        searchProjects[searchObj[obj].name] = Object.keys(searchObj)[i];
                        i++;
                    }
                });
                //console.log(searchProjects);
                return [{
                    projects: projectNames,
                    xmls: projectXML
                }]

            };

            //getting the list
            var comboplete = new Awesomplete('input.dropdown-input', {
                list: allProjects()[0].projects,
                minChars: 1,
                "awesomplete-selectcomplete": function(evnt) {
                    console.log(evnt.text);
                }
            });

            //action listener for dropdown button
            Awesomplete.$('.dropdown-btn').addEventListener("click", function() {
                if (comboplete.ul.childNodes != null && comboplete.ul.childNodes.length === 0) {
                    comboplete.minChars = 0;
                    comboplete.evaluate();
                } else if (comboplete.ul.hasAttribute('hidden')) {
                    comboplete.open();
                } else {
                    comboplete.close();
                }
            });

            //For loading the project once you select a project from the list
            Awesomplete.$('.dropdown-input').addEventListener("awesomplete-select", function(event) {
                $(".project-list").hide();
                Blockly.mainWorkspace.clear();
                $("#scratch").show();
                $("#signin").hide();
                $("#create").hide();
                $("#importModal").modal('hide');
                //loading blocks into DOM
                commonOpenProject(searchProjects[event.text.label]);
            });

            //comment part            
            const timeStamp = () => {
                let options = {
                    month: '2-digit',
                    day: '2-digit',
                    year: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                };
                let now = new Date().toLocaleString('en-US', options);
                return now;
            };

            var postComment = function() {
                if ($("#login").is(":visible")) {
                    $(".notification").html("Please login to comment").show();
                    setTimeout(function() {
                        $(".notification").fadeOut("slow");
                    }, 1000);
                } else {
                    if (globalVar.currentProjectId == null) {
                        $(".notification").html("Please save the project to comment").show();
                        setTimeout(function() {
                            $(".notification").fadeOut("slow");
                        }, 1000);
                    } else {
                        var ref = firebase.app().database().ref();
                        var commentRef = ref.child('Projects/' + globalVar.currentProjectId + "/comments");
                        e.preventDefault();
                        let name = document.getElementById("yourName").value;
                        let comment = document.getElementById("comment").value;

                        if (name && comment) {
                            commentRef.push({
                                name: name,
                                comment: comment,
                                time: timeStamp()
                            });
                        }

                        commentRef.on("child_added", function(snapshot) {
                            let comment = snapshot.val();
                            addComment(comment.name, comment.comment, comment.time);
                        });

                        document.getElementById("yourName").value = '';
                        document.getElementById("comment").value = '';
                    }
                }

            };

            const addComment = (name, comment, timeStamp) => {
                let comments = document.getElementById("commentsList");
                comments.innerHTML = `<hr><h4>${name} says<span>${timeStamp}</span></h4><p>${comment}</p>${comments.innerHTML}`;
            }

            //Code Reuse
            var reuseToolbar = function() {

                var blockList = [];
                projectMapper = {};
                var ref = firebase.app().database().ref();
                var projRef = ref.child('Projects/');
                projRef.once('value', function(snap) {
                    var projectObj = snap.val();
                    for (var obj in projectObj) {
                        blockList.push(projectObj[obj].name);
                        var latestVersion;
                        for (var version in projectObj[obj].versions) {
                            latestVersion = projectObj[obj].versions[version];
                        }
                        projectMapper[projectObj[obj].name] = latestVersion;
                    }
                    var list = $(".blockList");
                    for (var obj in blockList) {
                        list.append("<li role=\"presentation\"><a role=\"menuitem\" tabindex=\"-1\" href=\"#\">" + blockList[obj] + "</a></li>");
                    }
                }).then(function() {
                    $("#reuseModal").modal();
                    $('.dropdown-menu a').click(function() {
                        $('#reuseSelected').text($(this).text());
                    })
                });

            };

            //Reusing  int the project
            var reuseChangesModal = function() {
                var blockID = document.getElementById("reuseSelected").innerHTML
                if (blockID) {
                    //loading blocks into DOM
                    $("#reuseModal").modal('hide');
                    $("#scratch").show();
                    //Blockly.mainWorkspace.clear();
                    var xml = Blockly.Xml.textToDom(projectMapper[blockID]);
                    Blockly.Xml.domToWorkspace(xml, workspace);
                    $(".blockList").empty();
                } else {
                    //console.log("Please enter correct xml format");
                }
            };

            //Adding new functions defined to global variable
            globalVar['openProject'] = commonOpenProject;

            workspace.addChangeListener(blockToText);
            document.getElementById('sign-in').addEventListener('click', authentication.toggleSignIn, false);
            document.getElementById('facebook-login').addEventListener('click', authentication.facebookSignIn, false);
            document.getElementById('google-login').addEventListener('click', authentication.googleSignIn, false);
            document.getElementById('sign-up').addEventListener('click', authentication.handleSignUp, false);
            document.getElementById('saveProject').addEventListener('click', saveChangesModal, false);
            document.getElementById("save").addEventListener("click", saveToolbar);
            document.getElementById("saveVersion").addEventListener("click", saveVersion);
            document.getElementById("newProject").addEventListener("click", openNewProject);
            document.getElementById("uploadVersion").addEventListener("click", openFromVersion);
            document.getElementById("export").addEventListener("click", exportToolbar);
            document.getElementById("import").addEventListener("click", importToolbar);
            document.getElementById("importProject").addEventListener('click', importChangesModal, false);
            document.getElementById("commentButton").addEventListener('click', postComment);
            document.getElementById("codeReuse").addEventListener("click", reuseToolbar);
            document.getElementById("reuseBlocks").addEventListener("click", reuseChangesModal, false);
            document.getElementById("openVersion").addEventListener("click", versionOpenModal, false);
            //document.querySelector(".comments form").addEventListener("click", postComment);
        });
    </script>
</body>

</html>